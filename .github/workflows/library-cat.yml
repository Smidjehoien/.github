name: Library cat (optional)

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, edited]

permissions:
  pull-requests: read

jobs:
  library-cat:
    if: ${{ vars.ENABLE_LIBRARY_CAT == 'true' }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pullRequest = context.payload.pull_request
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pullRequest.number,
              per_page: 100,
            })

            const qualityIssues = []
            if (/\bWIP\b|fixup!|squash!/i.test(pullRequest.title || '')) qualityIssues.push('title')
            if (commits.some(commit => /\bWIP\b|fixup!|squash!/i.test(commit.commit.message))) qualityIssues.push('commits')

            const summaryMessage = qualityIssues.length ? `Needs another look (${qualityIssues.join(', ')})` : 'Looks calm'
            core.summary
              .addHeading('Library cat')
              .addList([summaryMessage])
              .write()
            if (qualityIssues.length) core.setFailed(summaryMessage)
