name: Library cat (optional)

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, edited]

permissions:
  pull-requests: read

jobs:
  library-cat:
    if: ${{ vars.ENABLE_LIBRARY_CAT == 'true' }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 30,
            })

            const wipPattern = /\bWIP\b|fixup!|squash!/i

            const bad = []
            if (wipPattern.test(pr.title || '')) bad.push('title')
            if (commits.some(c => wipPattern.test(c.commit.message))) bad.push('commits')

            const msg = bad.length ? `Needs another look (${bad.join(', ')})` : 'Looks calm'
            core.summary
              .addHeading('Library cat')
              .addList([msg])
              .write()
            if (bad.length) core.setFailed(msg)
