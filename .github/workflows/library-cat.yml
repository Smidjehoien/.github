name: Library cat (optional)

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, edited]

permissions:
  pull-requests: read

jobs:
  library-cat:
    if: ${{ vars.ENABLE_LIBRARY_CAT == 'true' }}
    continue-on-error: true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            })

            const issuesFound = []
            if (/\bWIP\b|fixup!|squash!/i.test(pr.title || '')) issuesFound.push('title')
            if (commits.some(commit => /\bWIP\b|fixup!|squash!/i.test(commit.commit.message))) issuesFound.push('commits')

            const statusMessage = issuesFound.length ? `Needs another look (${issuesFound.join(', ')})` : 'Looks calm'
            core.summary
              .addHeading('Library cat')
              .addList([statusMessage])
              .write()
            if (issuesFound.length) core.setFailed(statusMessage)
