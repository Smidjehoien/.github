name: CLA marker (reusable)

on:
  workflow_call:
    inputs:
      label_covered:
        description: "Label to apply when CLA is considered covered"
        required: false
        default: "CLA: covered"
        type: string
      label_review:
        description: "Label to apply when CLA status needs review"
        required: false
        default: "CLA: review"
        type: string
      allowlist_users:
        description: "Comma/space-separated GitHub usernames that are CLA-covered by policy"
        required: false
        default: ""
        type: string
      cover_org_members:
        description: "Treat members/owners of the base repository's organization as CLA-covered"
        required: false
        default: true
        type: boolean
      create_missing_labels:
        description: "Create labels if they do not exist"
        required: false
        default: false
        type: boolean
      cover_collaborators:
        description: "Treat repository collaborators as CLA-covered"
        required: false
        default: false
        type: boolean

jobs:
  mark:
    if: startsWith(github.event_name, 'pull_request')
    name: Mark CLA status
    permissions:
      contents: read
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate and label PR
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('This workflow must be triggered from a pull_request* event in the caller.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;

            const labelCovered = core.getInput('label_covered');
            const labelReview = core.getInput('label_review');
            const coverOrgMembers = core.getBooleanInput('cover_org_members');
            const coverCollaborators = core.getBooleanInput('cover_collaborators');
            const createMissing = core.getBooleanInput('create_missing_labels');

            const allowUsers = (core.getInput('allowlist_users') || '')
              .split(/[\s,]+/)
              .filter(Boolean)
              .map((username) => username.toLowerCase());

            const prAuthor = (pr.user && pr.user.login) ? pr.user.login : '';
            const association = (pr.author_association || '').toUpperCase();

            const isAllowlistedAuthor = allowUsers.includes(prAuthor.toLowerCase());
            const isOrgMemberAuthor = coverOrgMembers && ['MEMBER', 'OWNER'].includes(association);
            const isCollaborator = coverCollaborators && association === 'COLLABORATOR';
            const covered = isAllowlistedAuthor || isOrgMemberAuthor || isCollaborator;

            core.info(`PR #${issue_number} by @${prAuthor} (association=${association}) -> covered=${covered}`);

            // Ensure labels exist (create if missing)
            async function ensureLabel(name, color, description) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color, description });
                } else {
                  throw error;
                }
              }
            }

            if (createMissing) {
              await Promise.all([
                ensureLabel(labelCovered, '2ea44f', 'Contributor License Agreement is considered covered'),
                ensureLabel(labelReview, '9a9a9a', 'CLA status requires manual review')
              ]);
            }

            // Remove the opposite label if present, then add the desired one
            const desired = covered ? labelCovered : labelReview;
            const oppositeLabel = covered ? labelReview : labelCovered;

            // remove other label if present
            try {
              await github.rest.issues.removeLabel({ owner, repo, issue_number, name: oppositeLabel });
            } catch (error) {
              if (error.status !== 404) {
                core.warning(`Could not remove label '${oppositeLabel}': ${error.message}`);
              }
            }

            // add desired label (idempotent)
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [desired] });

            core.summary
              .addHeading('CLA marker')
              .addTable([
                [{data: 'PR', header: true}, {data: '#'+issue_number, header: false}],
                ['Author', '@'+prAuthor],
                ['Association', association || ''],
                ['Allowlisted users', allowUsers.join(', ') || '(none)'],
                ['Treat org members as covered', String(coverOrgMembers)],
                ['Result', covered ? labelCovered : labelReview],
              ])
              .write();
