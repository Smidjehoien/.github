name: CLA marker (reusable)

on:
  workflow_call:
    inputs:
      label_covered:
        description: "Label to apply when CLA is considered covered"
        required: false
        default: "CLA: covered"
        type: string
      label_review:
        description: "Label to apply when CLA status needs review"
        required: false
        default: "CLA: review"
        type: string
      allowlist_users:
        description: "Comma/space-separated GitHub usernames that are CLA-covered by policy"
        required: false
        default: ""
        type: string
      cover_org_members:
        description: "Treat members/owners of the base repository's organization as CLA-covered"
        required: false
        default: true
        type: boolean
      create_missing_labels:
        description: "Create labels if they do not exist"
        required: false
        default: false
        type: boolean
      cover_collaborators:
        description: "Treat repository collaborators as CLA-covered"
        required: false
        default: false
        type: boolean

jobs:
  mark:
    if: startsWith(github.event_name, 'pull_request')
    name: Mark CLA status
    permissions:
      contents: read
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate and label PR
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const pullRequest = context.payload.pull_request;
            if (!pullRequest) {
              core.setFailed('This workflow must be triggered from a pull_request* event in the caller.');
              return;
            }

            const repositoryOwner = context.repo.owner;
            const repositoryName = context.repo.repo;
            const pullRequestNumber = pullRequest.number;

            const labelCovered = core.getInput('label_covered');
            const labelReview = core.getInput('label_review');
            const shouldCoverOrgMembers = core.getBooleanInput('cover_org_members');
            const shouldCoverCollaborators = core.getBooleanInput('cover_collaborators');
            const shouldCreateMissingLabels = core.getBooleanInput('create_missing_labels');

            const allowlistedUsernames = (core.getInput('allowlist_users') || '')
              .split(/[\s,]+/)
              .filter(Boolean)
              .map((username) => username.toLowerCase());

            const pullRequestAuthor = (pullRequest.user && pullRequest.user.login) ? pullRequest.user.login : '';
            const authorAssociation = (pullRequest.author_association || '').toUpperCase();

            const isAllowlistedAuthor = allowlistedUsernames.includes(pullRequestAuthor.toLowerCase());
            const isOrgMemberAuthor = shouldCoverOrgMembers && ['MEMBER', 'OWNER'].includes(authorAssociation);
            const isCollaboratorAuthor = shouldCoverCollaborators && authorAssociation === 'COLLABORATOR';
            const isCLACovered = isAllowlistedAuthor || isOrgMemberAuthor || isCollaboratorAuthor;

            core.info(`PR #${pullRequestNumber} by @${pullRequestAuthor} (association=${authorAssociation}) -> covered=${isCLACovered}`);

            // Ensure labels exist (create if missing)
            async function ensureLabelExists(labelName, labelColor, labelDescription) {
              try {
                await github.rest.issues.getLabel({ owner: repositoryOwner, repo: repositoryName, name: labelName });
              } catch (error) {
                if (error.status === 404) {
                  await github.rest.issues.createLabel({ owner: repositoryOwner, repo: repositoryName, name: labelName, color: labelColor, description: labelDescription });
                } else {
                  throw error;
                }
              }
            }

            if (shouldCreateMissingLabels) {
              await ensureLabelExists(labelCovered, '2ea44f', 'Contributor License Agreement is considered covered');
              await ensureLabelExists(labelReview, '9a9a9a', 'CLA status requires manual review');
            }

            // Remove the opposite label if present, then add the desired one
            const desiredLabel = isCLACovered ? labelCovered : labelReview;
            const oppositeLabel = isCLACovered ? labelReview : labelCovered;

            // remove opposite label if present
            try {
              await github.rest.issues.removeLabel({ owner: repositoryOwner, repo: repositoryName, issue_number: pullRequestNumber, name: oppositeLabel });
            } catch (error) {
              if (error.status !== 404) {
                core.warning(`Could not remove label '${oppositeLabel}': ${error.message}`);
              }
            }

            // add desired label (idempotent)
            await github.rest.issues.addLabels({ owner: repositoryOwner, repo: repositoryName, issue_number: pullRequestNumber, labels: [desiredLabel] });

            core.summary
              .addHeading('CLA marker')
              .addTable([
                [{data: 'PR', header: true}, {data: '#'+pullRequestNumber, header: false}],
                ['Author', '@'+pullRequestAuthor],
                ['Association', authorAssociation || ''],
                ['Allowlisted users', allowlistedUsernames.join(', ') || '(none)'],
                ['Treat org members as covered', String(shouldCoverOrgMembers)],
                ['Result', isCLACovered ? labelCovered : labelReview],
              ])
              .write();
